
---



### **一、 虚拟化基础概念**

*   **什么是虚拟化**：将物理硬件资源（如CPU、内存、磁盘、网络）抽象化，生成一个或多个逻辑上独立的计算环境（即虚拟机）。
*   **技术类别**：
    *   **全虚拟化 (Full Virtualization)**：虚拟机无需修改操作系统，Hypervisor（虚拟机监控器）完整模拟底层硬件。KVM 属于此类。
    *   **半虚拟化 (Paravirtualization)**：需要修改虚拟机操作系统内核以配合Hypervisor工作，性能较高。
    *   **进程级虚拟化 (LXC)**：即容器技术，如Docker，共享宿主机内核，隔离性较弱但资源开销极小。

---

### **二、 KVM 平台的部署**

*   **硬件要求**：最关键的前提是物理主机的 **CPU必须支持虚拟化技术** (如 Intel VT-x 或 AMD-V)，并且需要在BIOS中开启。
*   **系统安装**：推荐使用最小化安装的Linux系统作为宿主机，以减少资源占用和攻击面。
*   **核心组件**：部署KVM平台需要安装 `qemu-kvm`, `libvirt`, `virt-install` 等核心软件包。
*   **管理工具**：可以安装Web控制台（如Kimchi, Cockpit）方便图形化管理，或使用命令行脚本进行自动化部署。

**常用命令示例:**
```bash
# 1. 检查CPU是否支持虚拟化（有输出则表示支持）
egrep '(vmx|svm)' /proc/cpuinfo

# 2. 安装KVM核心软件包 (以CentOS/RHEL为例)
yum install -y qemu-kvm libvirt-daemon virt-install

# 3. 启动并设置libvirtd服务开机自启
systemctl start libvirtd
systemctl enable libvirtd

# 4. 验证KVM模块是否加载
lsmod | grep kvm
```

---

### **三、 KVM 核心资源管理**

管理虚拟化平台的核心在于管理其三大资源：**网络**、**存储**和**虚拟机本身**。

**1. KVM 网络管理**

*   **核心目标**：为虚拟机提供网络连接能力。
*   **常用网络类型**：
    *   **桥接网络 (Bridge)**：将虚拟机的网卡桥接到宿主机的物理网卡上，使虚拟机像物理机一样直接连接到局域网，拥有独立的IP地址。
    *   **NAT 网络**：虚拟机通过宿主机进行网络地址转换来访问外部网络。
    *   **Host-Only 网络**：虚拟机只能与宿主机及同一宿主机上的其他虚拟机通信。

**常用命令示例:**
```bash
# 1. 查看当前KVM网络列表
virsh net-list --all

# 2. 启动一个NAT网络（如默认的default网络）
virsh net-start default

# 3. 设置网络为开机自启动
virsh net-autostart default

# 4. 查看指定网络信息
virsh net-info default
```

**2. KVM 存储管理**

*   **核心目标**：为虚拟机提供虚拟磁盘。
*   **存储池 (Storage Pool)**：一个用于存放虚拟机磁盘镜像文件的逻辑存储单元。默认位置为 `/var/lib/libvirt/images/`。
*   **磁盘镜像格式**：如 `raw` (性能好) 和 `qcow2` (支持快照)。

**常用命令示例:**
```bash
# 1. 查看当前存储池列表
virsh pool-list --all

# 2. 查看指定存储池信息（如默认的default池）
virsh pool-info default

# 3. 在存储池中创建一个新的虚拟磁盘（卷）
# 在 'default' 池中创建一个名为 'new-disk.qcow2' 的10G磁盘
virsh vol-create-as --pool default --name new-disk.qcow2 --capacity 10G --format qcow2

# 4. 查看存储池中的所有卷
virsh vol-list --pool default
```

---

### **四、 KVM 虚拟机的生命周期管理**

这部分是KVM平台最核心的日常操作，涵盖了从创建到销毁的全部环节。

**1. 创建虚拟机**

*   主要使用 `virt-install` 命令行工具创建。创建时需要定义虚拟机的各项配置参数。

**前提-上传镜像文件至`/iso`,创建自动应答文件vi /iso/centos_7_ks.cfg**:
```sh
############################################################################
## platform=x86, AMD64, 或 Intel EM64T
## version=DEVEL
## 设置：安装之后，自动重启
install
reboot
## 设置：root用户密码
auth --enableshadow --passalgo=sha512
rootpw --iscrypted '$1$1763$h3apvE5YW9Wq9I4Fpb4mY.'
## 设置：采用<图形化安装界面>
##       如果采用<非图形化安装方式，比如：consloe 文本方式>，则可以不设置 graphical
##       如果不确定，同样也可以不设置 graphical
## graphical
## 设置：第一次启动时，不运行设置向导
firstboot --disable
## 设置：键盘布局
keyboard --vckeymap=cn --xlayouts='cn'
## 设置：系统语言设定
lang zh_CN.UTF-8
## 设置：firewall防火墙，开放<ssh服务端口>
firewall --enabled --ssh
## 设置：<SELinux安全机制>为<--enforcing 或 --disabled>
selinux --disabled
## 设置：<日志级别>为<info>
logging --level=info
## 设置：<网卡配置>为<DHCP动态获取、开机自启动>
network --bootproto=dhcp --onboot=on
## 设置：<主机名称>为<localhost.localdomain>
network --hostname=localhost.localdomain
## 设置：<时区>为<Asia/Shanghai>
timezone Asia/Shanghai --isUtc
#############################################################################################################
## 设置：忽略<特殊的磁盘>，例如：<只读设备>，否则，<安装过程>将暂停，并提示<是否应该忽略该设备?>
##       语法1：ignoredisk --drives=drive1,drive2,...
##              表示：在<安装过程>中，忽略<指定的磁盘>
##       语法2：ignoredisk --only-use=sda
##              表示：在<安装过程>中，仅使用<指定的磁盘>，忽略<其他的磁盘>，从而不破坏<其他磁盘的数据>
#############################################################################################################
ignoredisk --only-use=sda
#############################################################################################################
## 针对在<安装过程>中<所使用的磁盘>：清除<所有分区>并<初始化磁盘>
##       --all        表示：<所有分区>
##       --initlabel  表示：<初始化磁盘>
#############################################################################################################
clearpart --all --initlabel
#############################################################################################################
## 设置：<bootloader启动加载>过程中的<相关参数>
##       --append=" crashkernel=auto" 设置：自动分配<kdump内存转储>所需的<内存空间>
##                                           ♦ 注意：<空格>必须有
##       --location=mbr     设置：<启动磁盘>的<引导分区类型>为<MBR分区>
##       --boot-drive=sda   指定：<启动磁盘>是<sda>，
##                                 ♦ 注意：虚拟机中必须是sda，但是在真实服务器上，可以是<其他磁盘，如：sdb>
#############################################################################################################
bootloader --append=" crashkernel=auto" --location=mbr --boot-drive=sda
#############################################################################################################
## 创建：磁盘分区
#############################################################################################################
part biosboot --fstype="biosboot" --ondisk=sda --size=1
              ## 划分：<基本分区>，--size=1    表示：1MB
part /boot    --fstype="xfs"      --ondisk=sda --size=1024
              ## 划分：<基本分区>，--size=1024 表示：1024MB
part pv.01    --fstype="lvmpv"    --ondisk=sda --size=1    --grow
              ## 创建：<PV物理卷>
              ##       --size=1                     表示：1MB
              ##       --grow                       表示：允许<PV物理卷>自动增长，以利用<可用的磁盘空间>
              ##       --size=1 和 --grow 联合使用，表示：利用<100%剩余的磁盘空间>
volgroup centos --pesize=4096 pv.01
              ## 创建：<VG卷组>，并设定<PE值>
logvol swap  --fstype="swap" --name=swap --vgname=centos --size=1024
             ## 创建：<LV逻辑卷>
logvol /     --fstype="xfs"  --name=root --vgname=centos --size=1    --grow
             ## 创建：<LV逻辑卷>
#############################################################################################################
## 设置：需要安装的组件
#############################################################################################################
%packages
##############################################
## 设置：在安装过程中，需要安装的<核心组件> ##
##############################################
@^minimal
@core
%end
##############################################
## 设置：在安装完成后，需要安装的<其他组件> ##
##############################################
%post --interpreter=/bin/bash
(
rm -rf /etc/yum.repos.d/*
curl https://mirrors.huaweicloud.com/artifactory/os-conf/centos/centos-7.repo -o /etc/yum.repos.d/centos7.repo
yum clean all
yum makecache fast
yum install -y qemu-guest-agent bash-completion net-tools wget
    ## qemu-guest-agent 是：来宾代理程序，可以让我们通过 virsh set-user-password 命令，来重置root口令
)
%end
```
**创建虚拟机示例:**
```bash
# 图形模式-创建虚拟机
name="centos-7-01"
diskpath="/var/lib/libvirt/images"
virt-install --os-variant centos7.0  --accelerate --autostart \
             --name $name \
             --vcpus 1,maxvcpus=2 \
             --memory 1024,maxmemory=2048 \
             --disk device=disk,bus=scsi,path=$diskpath/$name.disk01,format=qcow2,size=5,boot_order=1 \
             --network bridge=br0,model=virtio,boot_order=2 \
             --location /iso/CentOS-7-x86_64-Minimal-2009.iso \
             --initrd-inject=/iso/centos_7_ks.cfg --extra-args "ks=file:/centos_7_ks.cfg" \
             --extra-args "console=ttyS0" \
             --graphics vnc,port=-1,keymap='en-us' \
             &

# 文本模式-创建虚拟机
name="centos-7-02"
diskpath="/var/lib/libvirt/images"
virt-install --os-variant centos7.0  --accelerate --autostart \
             --name $name \
             --vcpus 1,maxvcpus=2 \
             --memory 1024,maxmemory=2048 \
             --disk device=disk,bus=scsi,path=$diskpath/$name.disk01,format=qcow2,size=5,boot_order=1 \
             --network bridge=br0,model=virtio,boot_order=2 \
             --location /iso/CentOS-7-x86_64-Minimal-2009.iso \
             --initrd-inject=/iso/centos_7_ks.cfg --extra-args "ks=file:/centos_7_ks.cfg" \
             --extra-args "console=ttyS0" \
             --nographics \
             &

```

**2. 基础管理**

*   使用 `virsh` 命令是管理虚拟机的主要方式。

**常用命令示例:**
```bash
###############################################################################
virsh console centos01          ## 连接到虚拟机的控制台
# 图形化工具连接
yum install openssh-askpass -y                          ## 创建图形化SSH口令应答组件
virt-manager                                            ## 本地连接
virt-manager -c qemu:///system                          ## 本地连接
virt-manager -c qemu+ssh://root@192.168.10.222/system   ## SSH连接远程主机
# 命令行工具连接
virsh                                                   ## 本地连接
virsh -c qemu:///system                                 ## 本地连接
virsh -c qemu+ssh://root@192.168.10.222/system          ## SSH连接远程主机
###############################################################################
virsh list                                   ## 列出正在运行的虚拟机
virsh list --all                             ## 列出所有虚拟机（包括已关闭的）

virsh autostart centos01                      ## 设置虚拟机随libvirtd服务的重启而启动
virsh autostart centos01 --disable            ## 禁止虚拟机随libvirtd服务的重启而启动

virsh start centos01                          ## 启动虚拟机
virsh shutdown centos01                       ## 正常关闭虚拟机
virsh destroy centos01                        ## 强制关闭虚拟机（类似拔电源）
virsh suspend centos01                        ## 暂停虚拟机
virsh resume centos01                         ## 唤醒虚拟机

# 重置：root密码 (虚拟机须安装 qemu-guest-agent 来宾代理程序)
virsh start centos01
virsh set-user-password centos01 --user root --password a123456!
# 查看：<虚拟机>的<桥接网卡IP地址> (虚拟机须安装 qemu-guest-agent 来宾代理程序)
virsh start centos01
virsh domifaddr centos01 --source agent --full

# 更名：<虚拟机>
virsh shutdown centos01
virsh domrename centos01 centos-1
virsh domrename centos-1 centos01

# 删除：<虚拟机>
virsh undefine centos01        ## 删除<虚拟机>, 但是，保留<关联的存储卷>
virsh undefine --remove-all-storage centos01 ## 删除<虚拟机>,并删除<关联的存储卷>
#############################################################################
```

**3. 高级管理：快照与克隆**

*   **快照**：为虚拟机状态创建一个可恢复的还原点。(仅仅只能针对qcow2格式的、文件型的虚拟机磁盘文件执行快照操作)
*   **克隆**：基于现有虚拟机快速创建一个新的副本。

**常用命令示例:**
**快照**：
```bash
# 1. 域快照
# 创建：快照
virsh snapshot-create-as centos01 --name "第一个快照"
virsh snapshot-create-as centos01 --name "第二个快照"

# 查看：快照列表
virsh snapshot-list centos01

# 查看：快照 XML 配置文件
ll /var/lib/libvirt/qemu/snapshot/centos01

# 恢复快照
virsh snapshot-revert centos01 --snapshotname "第一个快照"

# 删除快照
virsh snapshot-delete centos01 --snapshotname "第一个快照"
virsh snapshot-delete centos01 --snapshotname "第二个快照"

# 导出：快照 XML 配置文件
virsh snapshot-dumpxml --domain centos01 --snapshotname 第一个快照 --security-info > ~/centos01.快照1.xml

# 重构：快照 XML 配置文件 (用于：快照迁移)
# 1. 首先，导出<快照 XML 配置文件>
virsh snapshot-dumpxml --domain centos01 --snapshotname 第一个快照 --security-info > ~/centos01.快照1.xml
# 2. 重构：快照 (依据[快照 XML 配置文件])
virsh snapshot-create centos01 --xmlfile ~/centos01.快照1.xml --redefine
# 3. 查看：重构结果
ll /var/lib/libvirt/qemu/snapshot/centos01
virsh snapshot-list centos01

# 2. 卷快照
# 创建：快照
qemu-img snapshot -c 第一个快照 /var/lib/libvirt/images/centos01.disk0
qemu-img snapshot -c 第二个快照 /var/lib/libvirt/images/centos01.disk0

# 查看：快照
qemu-img snapshot -l /var/lib/libvirt/images/centos01.disk0

# 恢复快照
qemu-img snapshot -a 第一个快照 /var/lib/libvirt/images/centos01.disk0

# 删除快照
qemu-img snapshot -d 第一个快照 /var/lib/libvirt/images/centos01.disk0
qemu-img snapshot -d 第二个快照 /var/lib/libvirt/images/centos01.disk0

```
**克隆**：
```bash
# 1. 完整克隆：
# 注意：<完整/链接克隆>的<虚拟机>, <网卡 MAC 地址>可以做到不一样, 但是<SSH HOST KEY>是一模一样的.
# 1.1. 首先: 关闭<模板机>
virsh shutdown centos01
# 1.2. 创建: <完整克隆虚拟机>
virt-clone -o centos01 -n centos01-clone-server-01 --auto-clone
# 备注：
# -o centos01  指定: 克隆的<源模板机>
# -n centos01-clone01 指定: 克隆的<目标新机>
# --auto-clone 自动生成: <克隆机>的<卷文件>及其<XML 配置文件>, 从而防止<配置冲突>
# 当<源模板机>有多个<卷>时, 可以同时克隆多个<卷>, 并自动生成<卷文件名称>
# 1.3. 运行: <克隆机>
virsh start centos01-clone-server-01
virsh console centos01-clone-server-01
# 2. 链接克隆：
# 注意： <完整/链接克隆>的<虚拟机>, <网卡 MAC 地址>可以做到不一样, 但是<SSH HOST KEY>是一模一样的.
# 2.1. 首先：关闭<模板机>、删除<模板机>、仅仅保留<模板机的磁盘数据>
virsh shutdown centos01
virsh undefine centos01
# 2.2. 获取：<模板机>的<卷文件>
virsh domblklist centos01
# 2.3. 创建:<克隆机>的<增量卷>
# 我们既可以基于<文件型的虚拟机磁盘文件>来创建<增量卷>
# 示例: 可用下面命令来，
qemu-img create -q -b /var/lib/libvirt/images/centos01.disk0 \
-f qcow2 /var/lib/libvirt/images/centos01-clone-volume01.disk01
# 我们也可以基于<分区(卷)型的虚拟机磁盘块设备>来创建<增量卷>
# 示例: 
qemu-img create -q -b /dev/vg01/lv01 \
-f qcow2 /var/lib/libvirt/images/centos01-clone-volume01.disk01
# 我们也可以基于<iSCSI型的虚拟机磁盘设备>来创建<增量卷>
# 示例:
qemu-img create -q -b /dev/disk/by-path/ip-192.168.168.101:3260-iscsi-iqn.2016-06.192.168.168.101:iscsi-lv-lun-0 \
-f qcow2 /var/lib/libvirt/images/centos01-clone-volume01.disk01
# 示例：可用下面命令来显示
qemu-img info /var/lib/libvirt/images/centos01-clone-volume01.disk01
# 2.4. 创建: <链接克隆机>
name="centos01-clone-server-01"
diskpath="/var/lib/libvirt/images"
diskname="centos01-clone-volume01.disk01"
virt-install --os-variant centos7.0 --accelerate --autostart \
--name ${name} \
--memory 1024,maxmemory=2048 \
--vcpus 2,maxvcpus=2 \
--disk device=disk,path=${diskpath}/${diskname},format=qcow2 \
--boot hd \
--network bridge=br0,model=virtio \
--graphics vnc,port=-1,keymap='en-us' \
&
# 2.5. 运行: <克隆机>
virsh start centos01-clone-server-01
virsh console centos01-clone-server-01

```
