
---

## 第21章 IP 路由原理

*   **什么是路由**：
    *   **定义**：路由是指导路由器如何转发 IP 数据报文的路径信息。路由器是连接不同逻辑网段的网络设备，负责将数据包从一个网络发送到另一个网络。
    *   **路由表 (Routing Table)**：每台路由器都维护一张路由表，其中包含目的地址、下一跳、出接口、度量值等信息，路由器根据路由表转发 IP 报文。
    *   **逐跳性**：路由器的转发是逐跳进行的，每个路由器只负责将数据包在本站通过最优路径转发到下一个路由器，不影响其他设备的转发行为。
    *   **路由环路**：由错误的路由配置或协议缺陷导致，IP 报文在网络中循环转发，浪费带宽，最终可能导致网络瘫痪。
*   **路由表**：
    *   **路由表的构成**：路由表是路由器转发数据包的依据，包含以下要素：
        *   **目的地址/掩码 (Destination/Mask)**：标识 IP 数据报文的目的地址或目的网络。
        *   **下一跳地址 (Next-hop)**：更接近目的网络的下一个路由器地址。
        *   **出接口 (Interface)**：IP 包将从该路由器哪个接口转发。
        *   **度量值 (Metric)**：到达目的地的代价，用于在有多条路径时选择最优路径。
    *   **路由表项类型**：
        *   **主机路由**：掩码长度为 32 位，匹配单一 IP 地址。
        *   **子网路由**：掩码长度小于 32 位但大于 0，匹配一个子网。
        *   **默认路由**：掩码长度为 0，匹配所有 IP 地址（当没有其他更精确的路由匹配时使用）。
*   **路由器单跳操作**：
    *   **转发过程**：
        1.  路由器收到 IP 报文，提取目的 IP 地址。
        2.  与路由表中的路由项进行匹配，选择最长匹配（掩码最长）的路由项。
        3.  如果匹配到路由项：
            *   检查下一跳地址是否在直连链路上。
            *   若在直连链路上，则直接通过出接口转发。
            *   若不在直连链路上，则需要对下一跳地址进行迭代查找，直到找到最终的直连下一跳。
        4.  确定最终的下一跳后，进行地址解析获取链路层地址，封装报文并从出接口转发。
        5.  如果未匹配到路由项，且没有默认路由，则丢弃该数据包。
        6.  如果未匹配到路由项，但有默认路由，则按照默认路由转发。
*   **路由的来源**：
    *   **直连 (Direct) 路由**：
        *   **特点**：无需配置，当接口配置 IP 地址且状态正常时自动生成。开销小，配置简单，无需人工维护。
        *   **局限**：只能发现本接口所属网段的路由。
    *   **静态 (Static) 路由**：
        *   **特点**：由管理员手工配置。开销小，配置简单，适合拓扑简单的网络。
        *   **局限**：当网络故障时不会自动修正，需要人工维护。
    *   **动态路由协议 (Routing Protocol) 发现的路由**：
        *   **特点**：由路由协议自动发现和修改路由。开销大，配置复杂，无需人工维护，适合拓扑复杂的网络。
*   **路由的度量 (Metric)**：
    *   **定义**：表示到达目的地的代价，也称为路由权值。
    *   **影响因素**：线路延迟、带宽、线路使用率、线路可信度、跳数、最大传输单元 (MTU) 等。
    *   **不同路由协议的度量值**：
        *   **静态路由**：固定值 0。
        *   **RIP**：使用“跳数”作为度量值，跳数越小越优。
        *   **OSPF**：使用“链路带宽”作为度量值，带宽越大开销越小。
    *   **度量值比较**：度量值只在同一种路由协议内部有意义，不同协议间的度量值不可直接比较。
*   **路由优先级 (Preference)**：
    *   **定义**：代表路由协议的可信度，数值越小优先级越高。
    *   **作用**：当到相同目的地址有多个路由来源时，路由器根据优先级选择最优路由。
    *   **各类路由默认优先级**：直连路由 (0)、OSPF 内部路由 (10)、静态路由 (60)、RIP 路由 (100)、OSPF 外部路由 (150)、BGP 路由 (255)。
    *   **配置**：除直连路由外，其他路由协议的优先级可根据需求手工配置。
*   **路由环路**：
    *   **产生原因**：配置错误（如静态路由下一跳相互指向）或协议缺陷（如某些动态路由协议在特定环境下配置不当）。
    *   **危害**：数据包在网络中死循环，浪费带宽，导致网络拥塞。
*   **查看设备的路由表**：
    *   **查看 IP 路由表摘要信息**：`display ip routing-table`。
    *   **查看符合指定目的地址的路由信息**：`display ip routing-table ip-address [ mask-length | mask ]`。
    *   **查看路由表的统计信息**：`display ip routing-table statistics`。

---
## 第22章 直连路由和静态路由

*   **直连路由**：
    *   **建立**：当路由器接口配置 IP 地址且物理层和链路层状态为 `up` 时，该接口所属网段的直连路由会自动生成并进入路由表。
    *   **VLAN 间路由**：
        *   **不适当的方式**：为每个 VLAN 建立一条物理连接，占用大量物理接口和线缆。
        *   **802.1Q 和子接口实现 (单臂路由)**：
            *   通过一条物理链路连接路由器和交换机。
            *   在路由器上配置物理接口的子接口，每个子接口对应一个 VLAN，并配置相应 VLAN 的 802.1Q 标记值和 IP 地址。
            *   交换机上连接路由器的端口配置为 Trunk 端口，允许所有 VLAN 数据通过。
            *   优点是节省物理端口和线缆，但 Trunk 链路带宽需较高。
        *   **三层交换机实现**：
            *   三层交换机内置三层路由转发引擎。
            *   为每个 VLAN 创建一个虚拟的三层 VLAN 接口 (SVI)，并配置 IP 地址。
            *   优点是硬件转发速度快，吞吐量大，避免外部物理连接延迟，性能优于路由器实现的 VLAN 间路由。
*   **静态路由**：
    *   **配置**：`ip route-static dest-address { mask-length | mask } { interface-type interface-number [ next-hop-address ] | next-hop-address } [ preference preference-value ]`。
        *   `dest-address`：目的 IP 地址。
        *   `mask-length | mask`：子网掩码或掩码长度。
        *   `interface-type interface-number`：出接口。
        *   `next-hop-address`：下一跳 IP 地址。
        *   `preference preference-value`：路由优先级（默认 60）。
    *   **配置要点**：
        *   所有路由器上都必须配置到所有网段的路由。
        *   下一跳地址必须是直连链路上可达的地址。
        *   如果出接口是广播类型接口（如以太网、VLAN 接口），必须指定下一跳地址。
        *   如果目标地址是主机地址且在直连网络中，或出接口是点到点接口，可以只指定出接口。
*   **静态默认路由**：
    *   **配置**：`ip route-static 0.0.0.0 0.0.0.0 next-hop-address [ preference preference-value ]`。
    *   **作用**：当没有其他更精确的路由匹配时，将数据包转发到指定下一跳。常用于末端网络（Stub Network）连接外部网络。
    *   **优点**：减少路由表项数量，节省路由表空间，加快路由匹配速度。
*   **用静态路由实现路由备份和负载分担**：
    *   **路由备份**：配置到相同目的地址的多条路由，通过设置不同的优先级，使优先级高的路由作为主路由，优先级低的作为备份路由。当主路由失效时，自动切换到备份路由。
    *   **负载分担**：配置到相同目的地址的多条路由，并设置相同的优先级，使流量均匀分布在这些路径上。
*   **静态黑洞路由的应用**：
    *   **定义**：下一跳为 `NULL0` 接口的静态路由。
    *   **作用**：将特定目的地址的报文丢弃，避免路由环路。
    *   **应用场景**：当聚合路由涵盖了不存在的子网，或在网络故障时可能导致路由环路时，配置黑洞路由可以防止报文在网络中无限循环。

---
## 第23章 路由协议概述

*   **可路由协议与路由协议**：
    *   **可路由协议 (Routed Protocol)**：指可以被路由器转发的协议，工作在 OSI 模型的网络层。例如 IP (IPv4, IPv6) 协议。
    *   **路由协议 (Routing Protocol)**：指路由器用来计算、维护和交换路由信息的协议，工作在传输层或应用层。例如 RIP、OSPF、BGP。
*   **路由协议在协议栈中的位置**：
    *   **RIP**：基于 UDP 协议，端口 520。
    *   **OSPF**：基于 IP 协议，协议号 89。
    *   **BGP**：基于 TCP 协议，端口 179。
*   **路由协议的基本原理**：
    *   **共同目的**：计算并维护路由。
    *   **工作过程**：
        1.  **邻居发现**：路由器通过发送广播或单播报文，主动向网段内的其他路由器介绍自己，建立邻居关系。
        2.  **交换路由信息**：路由器将其已知的路由信息发送给邻居路由器，邻居再转发给其他路由器，最终所有路由器都收到网络中的路由信息。
        3.  **计算路由**：路由器运行特定的算法（如 Bellman-Ford 或 Dijkstra），根据收集到的路由信息计算出到达所有目的地的最优路径。
        4.  **维护路由**：路由器之间周期性地发送协议报文，感知网络拓扑变化和设备故障，及时更新路由信息。
*   **路由协议的分类**：
    *   **按工作范围**：
        *   **IGP (Interior Gateway Protocols，内部网关协议)**：在同一个自治系统 (AS) 内部交换路由信息。例如 RIP、OSPF、IS-IS。
        *   **EGP (Exterior Gateway Protocols，外部网关协议)**：在不同自治系统之间交换路由信息，主要用于控制路由信息在 AS 间的传播。例如 BGP。
    *   **按寻径算法和信息交换方式**：
        *   **距离矢量 (Distance-Vector) 路由协议**：
            *   **算法**：Bellman-Ford 算法。
            *   **特点**：路由器周期性地向邻居发送完整的路由表，根据邻居的路由表更新自己的路由表。关心到目的网段的距离（跳数）和方向。
            *   **示例**：RIP、BGP。
            *   **缺点**：收敛速度慢，易产生路由环路，扩展性差（RIP 最大跳数 15）。
        *   **链路状态 (Link-State) 路由协议**：
            *   **算法**：Dijkstra (SPF) 算法。
            *   **特点**：路由器建立链路状态数据库 (LSDB)，描述网络拓扑结构。每个路由器向区域内所有其他路由器通告链路状态信息 (LSA)，当链路状态发生变化时才发送更新。
            *   **示例**：OSPF、IS-IS。
            *   **优点**：收敛速度快，不易产生路由环路，扩展性好。
            *   **缺点**：占用更多路由器内存和 CPU 处理能力。
*   **衡量路由协议的主要指标**：
    *   **协议计算的正确性**：协议使用的算法能否计算出最优、无环路的路由。
    *   **路由收敛速度**：网络拓扑变化后，路由器感知并更新路由信息的速度。
    *   **协议占用系统开销**：协议运行所需的内存、CPU 和网络带宽资源。
    *   **协议自身的安全性**：协议是否具备防止攻击的安全机制。
    *   **协议适用网络规模**：协议能适应的网络拓扑结构和规模大小。

---
## 第24章 OSPF 基础

*   **OSPF 基本原理**：
    *   **什么是 OSPF**：
        *   **定义**：OSPF (Open Shortest Path First，开放最短路径优先) 是 IETF 开发的基于链路状态的自治系统内部路由协议，替代 RIP 协议，由 RFC 2328 定义。
        *   **特点**：
            *   基于链路状态，使用 SPF 算法计算最短路径。
            *   只传播链路状态信息，收敛迅速，有效避免网络资源浪费。
            *   直接工作在 IP 层之上，协议号 89。
            *   以组播地址 (224.0.0.5) 发送协议包。
            *   具备更大的扩展性、安全性和 QoS 支持。
    *   **OSPF 协议工作过程概述**：
        1.  **寻找邻居 (Neighbor Discovery)**：OSPF 路由器周期性发送 Hello 包 (组播 224.0.0.5) 寻找邻居，协商参数。
        2.  **建立邻接关系 (Adjacency)**：邻居路由器之间协商成功后，建立可靠的邻接关系。在广播型网络中，需要选举指定路由器 (DR) 和备份指定路由器 (BDR)。
            *   **DR/BDR 选举**：具备选举资格的路由器中，优先级最高（默认为 1，0 表示不参与选举）的路由器被选为 BDR，次高者被选为 DR。若优先级相同，Router ID 大者优先。DR 和 BDR 选定后，即使有优先级更高的路由器加入也不会重新选举。DR 负责管理网络中所有路由器的链路状态信息交互。
        3.  **链路状态信息传递**：邻接路由器之间通过发布链路状态通告 (LSA) 交换链路状态信息，构建链路状态数据库 (LSDB)。LSA 描述路由器接口和链路的状态（带宽、开销等）。
            *   **可靠性**：OSPF 协议包具备超时重传和序列号机制，并支持 VLSM。
        4.  **计算路由**：每个路由器根据完整的 LSDB，独立运行 SPF 算法，计算出以自身为根的最短路径树，从而获得最优路由。
    *   **OSPF 优势**：
        *   路由器对网络拓扑有相同认识，不会产生路由环路。
        *   网络结构变更时收敛速度快。
        *   引入 Router ID 概念，便于跟踪路由器行为。
        *   选路与网络能力（带宽）挂钩，选路更合理。
        *   多重可靠性机制，节省网络资源。
*   **OSPF 分区域管理**：
    *   **产生背景**：随着网络规模扩大，单一区域的 OSPF 会导致路由器内存和 CPU 消耗过大，Hello 包和 LSA 更新包负担加重。
    *   **区域 (Area)**：OSPF 将自治系统划分为多个区域，每个区域内的路由器只维护本区域的 LSDB。
    *   **区域 ID (Area ID)**：32 位数字，标识 OSPF 区域，可用十进制或点分十进制表示。
    *   **区域类型**：
        *   **骨干区域 (Backbone Area)**：Area 0，所有非骨干区域必须与骨干区域相连，负责区域间路由信息的汇总和传递。
        *   **非骨干区域**：其他区域。
    *   **路由器类型**：
        *   **内部路由器 (Internal Router)**：所有接口都属于同一个区域。
        *   **区域边界路由器 (Area Border Router, ABR)**：连接一个或多个区域到骨干区域。
        *   **自治系统边界路由器 (Autonomous System Boundary Router, ASBR)**：连接 OSPF 自治系统到其他自治系统。
    *   **LSA 发布**：ABR 负责将本区域的 LSA 发布到骨干区域，并聚合路由信息，减少 LSA 数量。
*   **配置 OSPF**：
    *   **OSPF 基本配置命令**：
        1.  配置 Router ID：`router id router-id`。
        2.  启动 OSPF 进程：`ospf [ process-id ]`。
        3.  配置 OSPF 区域：`area area-id`。
        4.  在指定接口上启动 OSPF：`network ip-address wildcard-mask`。
    *   **OSPF 可选配置命令**：
        1.  配置 OSPF 接口优先级 (DR-Priority)：`ospf dr-priority priority`（0-255，默认 1）。
        2.  配置 OSPF 接口开销 (Cost)：`ospf cost value`。
        *   **注意**：DR 和 BDR 选举后，即使调整优先级，也不会重新选举，除非 DR/BDR 失效。
*   **OSPF 信息显示与调试**：
    *   **OSPF 信息显示**：
        *   **显示 OSPF 邻居信息**：`display ospf peer [ process-id ] [ verbose ]`。
        *   **显示 OSPF 链路状态数据库**：`display ospf lsdb [ process-id ] [ verbose ]`。
        *   **显示 OSPF 路由信息**：`display ospf routing [ process-id ] [ verbose ]`。
        *   **显示 OSPF 摘要信息**：`display ospf [ process-id ] [ verbose ]`。
        *   **显示 OSPF 接口信息**：`display ospf [ process-id ] interface [ interface-type interface-number | verbose ]`。
    *   **调试 OSPF**：
        *   **调试 OSPF 事件**：`debugging ospf event`。
        *   **调试 OSPF 链路状态通告**：`debugging ospf lsa`。
        *   **调试 OSPF 包**：`debugging ospf packet`。
        *   **调试 OSPF 路由计算**：`debugging ospf spf`。
        *   **调试 OSPF 进程**：`debugging ospf process-id`。