
---

## 第25章 用访问控制列表实现包过滤

*   **ACL 概述**：
    *   **定义**：ACL (Access Control List，访问控制列表) 是一种用于识别数据包的机制，通过一系列匹配条件对报文进行分类。
    *   **功能**：ACL 根据匹配条件（如源/目的 IP 地址、端口号、协议类型等）决定对数据包执行转发或丢弃操作，实现包过滤功能。
    *   **应用方面**：
        *   **包过滤防火墙**：根据 ACL 规则允许或拒绝数据包通过。
        *   **NAT (Network Address Translation，网络地址转换)**：规定哪些数据包需要进行地址转换。
        *   **QoS (Quality of Service，服务质量)**：对数据包进行分类，为不同类别的数据提供不同服务质量。
        *   **路由策略和过滤**：在路由发布和接收时，通过 ACL 过滤路由信息。
        *   **按需拨号**：配置路由器在需要发送特定数据时才发起拨号连接。
*   **基于 ACL 的包过滤**：
    *   **基本工作原理**：
        *   ACL 应用于路由器接口，并具有方向性（入站/出站）。
        *   数据包经过一个接口时，只会被该接口上对应方向的 ACL 过滤。
        *   ACL 对进出的数据包逐个检查，根据规则决定丢弃或允许通过。
	        ![550](assets/第6篇%20配置安全的分支网络/基于ACL的包过滤.png)
    *   **ACL 包过滤工作流程**：
        *   **入站包过滤**：
            1.  数据包进入接口。
            2.  检查是否配置入方向 ACL。
            3.  若配置，则按照 ACL 规则（rule）从上到下逐条匹配。
            4.  若匹配到规则：
                *   `permit`（允许）：数据包通过防火墙，提交给路由转发进程。
                *   `deny`（拒绝）：数据包被丢弃。
            5.  若未匹配到任何规则，则执行默认规则：默认动作为 `deny`（丢弃）。
        *   **图示**：  
	        ![550](assets/第6篇%20配置安全的分支网络/入站包过滤.png)
        *   **出站包过滤**：
            1.  数据包到达出接口。
            2.  检查是否配置出方向 ACL。
            3.  若配置，则按照 ACL 规则从上到下逐条匹配。
            4.  若匹配到规则，执行相应动作（`permit` 或 `deny`）。
            5.  若未匹配到任何规则，则执行默认规则：默认动作为 `deny`（丢弃）。  
        *   **图示**：    
	        ![550](assets/第6篇%20配置安全的分支网络/出站包过滤.png)
*   **通配符掩码 (Wildcard Mask)**：
    *   **定义**：与 IP 地址结合使用，描述一个地址范围。
    *   **特点**：与子网掩码相似但含义不同。
        *   二进制 0：表示对应位必须进行比较。
        *   二进制 1：表示对应位不进行比较。
    *   **应用**：ACL 规则中用于设定源/目的 IP 地址的匹配范围。
*   **ACL 分类**：
    *   **基本 ACL**：
        *   **标识**：数字序号范围 2000-2999。
        *   **规则**：只根据报文的源 IP 地址信息制定匹配规则。
    *   **高级 ACL**：
        *   **标识**：数字序号范围 3000-3999。
        *   **规则**：根据报文的源 IP 地址、目的 IP 地址、协议类型、协议特性（如端口号）等三、四层信息制定匹配规则。
    *   **二层 ACL**：
        *   **标识**：数字序号范围 4000-4999。
        *   **规则**：根据报文的源 MAC 地址、目的 MAC 地址、802.1p 优先级、二层协议类型等二层信息制定匹配规则。
    *    **ACL类型对比表**：

| 特性/维度           | **基础ACL (Basic ACL)**                                                  | **高级ACL (Advanced ACL)**                                                                                                | **二层ACL (Layer 2 ACL)**                                                                |
| --------------- | ---------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| **编号范围**        | 2000 - 2999                                                            | 3000 - 3999                                                                                                             | 4000 - 4999                                                                            |
| **匹配条件**        | **仅源IP地址**                                                             | **源IP、目的IP、协议、端口**、ICMP类型、TCP标记等                                                                                        | **源MAC、目的MAC、VLAN ID、以太网类型**、802.1Q优先级等                                                |
| **过滤层级**        | 网络层（L3）                                                                | 网络层（L3）                                                                                                                 | 数据链路层（L2）                                                                              |
| **主要应用场景**      | • 路由策略（过滤路由）  <br>• 简单NAT（仅基于源IP）  <br>• 窄带流量分类（QoS）  <br>• 接口入方向的基础过滤 | • **安全访问控制**（防火墙策略）  <br>• 精细NAT（端口映射）  <br>• **应用级QoS**（限速、优先级）  <br>• 复杂的路由过滤  <br>• 接口精细过滤                           | • **基于MAC地址的访问控制**  <br>• VLAN间流量控制  <br>• **防止MAC地址泛洪**  <br>• 基于以太网类型的过滤（如仅允许IPv4流量） |
| **H3C HCL配置示例** | `acl basic 2000`  <br>`rule 5 permit source 192.168.1.0 0.0.0.255`     | `acl advanced 3000`  <br>`rule 5 permit tcp source 192.168.1.0 0.0.0.255 destination 10.0.0.1 0 destination-port eq 80` | `acl l2 4000`  <br>`rule 5 permit source-mac 00-11-22-33-44-55`                        |
| **性能影响**        | 解析快，资源消耗低                                                              | 解析相对复杂，资源消耗较高                                                                                                           | 解析较快（L2匹配），资源消耗较低                                                                      |
| **优点**          | 配置简单，快速匹配源IP                                                           | 功能强大，控制粒度细                                                                                                              | 能处理L2流量，安全隔离性强                                                                         |
| **缺点**          | 控制粒度粗，无法区分目的/服务                                                        | 配置复杂，规则多时影响性能                                                                                                           | 无法处理L3及以上流量，应用范围有限                                                                     |

*   **配置 ACL 包过滤**：
    *   **ACL 包过滤配置任务**：
        1.  **设置包过滤功能的默认过滤规则**：默认动作为 `permit`，可修改为 `deny` (`packet-filter default deny`)。
        2.  **根据需要选择合适的 ACL 分类**：基本 ACL、高级 ACL、二层 ACL。
        3.  **创建正确的规则**：设置匹配条件和动作 (`permit` / `deny`)。
        4.  **在路由器的接口上应用 ACL**：并指明过滤报文的方向（入站 `inbound` / 出站 `outbound`）。
    *   **配置基本 ACL**：
        1.  设置 ACL 序列号：`acl basic acl-number`。
        2.  定义规则：`rule [ rule-id ] { deny | permit } [ counting | fragment | logging | source { object-group address-group-name | source-address source-wildcard | any } | time-range time-range-name | vpn-instance vpn-instance-name ]`。
    *   **配置高级 ACL**：
        1.  设置 ACL 序列号：`acl advanced acl-number`。
        2.  定义规则：`rule [ rule-id ] { deny | permit } protocol [ { { ack ack-value | fin fin-value | psh psh-value | rst rst-value | syn syn-value | urg urg-value } | established } | counting | destination { object-group address-group-name | dest-address dest-wildcard | any } | destination-port { object-group port-group-name | operator port1 [ port2]} | { dscp dscp | { precedence precedence | tos tos } } | fragment | icmp-type { icmp-type [ icmp-code ] | icmp-message } | logging | source { object-group address-group-name | source-address source-wildcard | any } | source-port { object-group port-group-name | operator port1 [ port2 ] } | time-range time-range-name | vpn-instance vpn-instance-name ]`。
    *   **配置二层 ACL**：
        1.  设置 ACL 序列号：`acl mac acl-number`。
        2.  定义规则：`rule [ rule-id] { deny | permit } [ cos dot1p | counting | dest-mac dest-address dest-mask | { Isap Isap-type Isap-type-mask | type protocol-type protocol-type-mask } | source-mac source-address source-mask | time-range time-range-name ]`。
    *   **在接口上应用 ACL**：`packet-filter { acl-number | name acl-name } { inbound | outbound }`。
*   **ACL 包过滤的注意事项**：
    *   **ACL 规则的匹配顺序**：
        *   **配置顺序 (config)**：按照用户配置规则的先后顺序进行匹配。
        *   **自动排序 (auto)**：系统优先匹配地址范围小的规则。
        *   不同匹配顺序会导致不同的过滤结果。
    *   **在网络中的正确位置配置 ACL 包过滤**：
        *   **高级 ACL**：应部署在靠近被过滤源的接口上，以尽早阻止不必要的流量进入网络。
        *   **基本 ACL**：应部署在靠近被拒绝源的接口上，以在不影响合法访问的前提下，尽可能使 ACL 靠近被拒绝的源。
    *   **ACL 包过滤的局限性**：
        *   **无法识别应用层信息**：ACL 基于二、三、四层信息过滤，无法根据用户名等应用层信息进行过滤。
        *   **静态防火墙**：过滤规则预先定义，无法动态检测应用层协议的动态端口。

---
## 第26章 网络地址转换

*   **NAT 概述**：
    *   **背景**：IPv4 地址短缺，公有地址由 IANA 统一分配，私有地址可自由分配用于内部网络。私有地址无法在 Internet 上路由。
    *   **定义**：NAT (Network Address Translation，网络地址转换) 是一种技术，将私有地址转换为公有地址，使私有网络中的主机可以通过共享少量公有地址访问 Internet。
    *   **优点**：缓解 IPv4 地址短缺，提高私有网络安全性。
    *   **常用术语**：
        *   **公网 (Public Network)**：使用公有地址，或无需地址转换的网络，对应公有地址 (Public Address) 或全局地址 (Global Address)。
        *   **私网 (Private Network)**：使用私有地址，或需要地址转换的网络，对应私有地址 (Private Address) 或本地地址 (Local Address)。
        *   **NAT 设备 (NAT device)**：介于公网和私网之间，执行地址转换的设备。
        *   **TU Port**：与 IP 地址相关联的 TCP/UDP 端口。
        *   **地址池 (Address Pool)**：用于 NAT 转换的公有地址集合。
*   **Basic NAT**：
    *   **原理**：实现私有地址与公有地址的**一对一映射**。一个私有 IP 地址对应一个公有 IP 地址。
    *   **过程**：
        1.  私网主机向公网服务器发送报文，源 IP 为私有地址，目的 IP 为公网地址。
        2.  NAT 设备收到报文，查找 NAT 表，若无匹配项，则从地址池中分配一个公有 IP 地址与私有 IP 地址进行映射，并替换报文源 IP 地址为公有 IP 地址，更新 NAT 表。
        3.  NAT 设备将报文转发到公网。
        4.  公网服务器回应报文，目的 IP 为公有 IP 地址。
        5.  NAT 设备收到回应报文，根据 NAT 表将报文目的 IP 地址替换为私有 IP 地址。
        6.  NAT 设备将报文转发给私网主机。
    *   **局限性**：一对一映射，无法解决公有 IP 地址不足的问题。
*   **NAPT (Network Address Port Translation，网络地址端口转换)**：
    *   **原理**：实现私有地址与公有地址的**多对一映射**。多个私有 IP 地址可以通过共享一个公有 IP 地址的不同端口访问公网。
    *   **优点**：显著提高公有 IP 地址的利用效率，解决公有 IP 地址不足的问题。
    *   **配置**：
        1.  配置地址池：`nat address-group group-number address start-address end-address`。
        2.  配置 ACL：用于匹配需要进行 NAT 转换的报文。
        3.  关联 ACL 与地址池：在出接口视图下使用 `nat outbound acl-number address-group group-number [ no-pat ]` 命令。
            *   `no-pat` 关键字：表示禁止端口转换，即 Basic NAT。
*   **Easy IP**：
    *   **原理**：NAPT 的一种特例，NAT 设备直接使用**出接口的 IP 地址**作为转换后的源地址，无需预先配置地址池。
    *   **优点**：配置简单，适用于拨号接入 Internet 或动态获得 IP 地址的场合。
    *   **配置**：
        1.  配置 ACL：用于匹配需要进行 NAT 转换的报文。
        2.  关联 ACL 与出接口：在出接口视图下使用 `nat outbound acl-number` 命令。
*   **NAT Server**：
    *   **原理**：将私有网络内部的服务器（如 Web 服务器、FTP 服务器）的**私有 IP 地址/端口静态映射成公有 IP 地址/端口**，使公网用户可以主动访问私网服务器。
    *   **作用**：解决 NAT 隐藏内部网络结构的问题，使内部服务器可对外提供服务。
    *   **配置**：`nat server [ protocol pro-type ] global { global-address | current-interface | interface interface-type interface-number } [ global-port ] [ vpn-instance global-vpn-instance-name ] inside local-address [ local-port ] [ vpn-instance local-vpn-instance-name ] [ acl { ipv4-acl-number | name ipv4-acl-name } ] [ reversible ] [ rule rule-name ] [ disable ] [ counting ]`。
*   **NAT ALG (Application Level Gateway，应用层网关)**：
    *   **原理**：NAT 的增强特性，能够识别应用层协议（如 FTP、H.323、SIP 等）中内嵌的 IP 地址和端口信息，并在地址转换时对这些信息进行同步转换。
    *   **作用**：解决传统 NAT 无法正确转换应用层协议中内嵌 IP 地址和端口的问题。
    *   **局限性**：支持的协议种类有限，对于非标准或新出现的应用可能无法支持。
*   **NAT 的信息显示和调试**：
    *   **显示地址转换信息**：`display nat { address-group group-number | all | outbound port-block-group | server | statistics | session }`。
    *   **调试地址转换过程**：`debugging nat { alg | config | event | packet acl number }`。
    *   **清除地址转换连接**：`reset nat session`。