
---

## 第27章 广域网基本原理

*   **广域网的作用**：
    *   **产生背景**：局域网（LAN）只能解决小范围内的资源共享和通信，无法满足远距离计算机网络通信的需求。
    *   **定义**：WAN (Wide Area Network，广域网) 旨在延伸网络到更远的物理距离（城市、国家甚至全球范围），实现分散在不同地理位置的局域网互联。
    *   **挑战**：
        *   **距离限制**：早期 LAN 技术（如快速以太网 100BASE-TX）传输距离有限，难以支持百千米甚至上万千米的远程传输。
        *   **专用线路成本**：即使光纤以太网传输距离增加，普通用户也难以承担专用长距离线路的布设成本和许可。
    *   **解决方案**：利用电信运营商提供的基础通信设施（如语音网络），构建远程连接，实现远距离数据、语音、视频等资源的共享。
    *   **路由器作用**：广域网通常需要路由器连接不同介质的局域网和广域网，处理复杂的广域网协议，并跨越网段进行通信。路由器需要支持丰富的接口类型以适应各种广域网链路技术。
*   **广域网基本概念**：
    *   **广域网与 OSI 参考模型**：
        *   运营商关注：如何在现有电信传输网基础上，结合语音和数据业务，最大化网络资源利用率。
        *   网络技术人员关注：如何在运营商传输网上，连接不同地理位置的 LAN，重点研究物理层接口标准、数据链路层协议和网络层 IP 协议。
    *   **物理层标准**：
        *   **G.703 接口**：支持 E1/T1 线路（E1 用于欧亚，T1 用于北美）。
        *   **POS (Packet Over SDH) 接口**：高速广域网接口，速率 155M-40G，将 IP 数据包映射到 SDH 同步载荷进行远程传输。
        *   **CPOS (Channelized POS)**：通道化 POS 接口，提供带宽精细划分能力，减少路由器低速物理端口数量。
        *   **BNC 接口 (Bayonet Nut Connector)**：用于同轴电缆连接，屏蔽性好，信号稳定，传输距离长。
        *   **SFP/SFP+ 接口 (Small Form-factor Pluggable)**：小封装可插拔光模块，将千兆/万兆电信号转换为光信号。
    *   **数据链路层协议**：
        *   **HDLC (High-level Data Link Control)**：高级数据链路控制，用于同步点到点连接，面向比特，透明传输，只能同步工作。
        *   **PPP (Point-to-Point Protocol)**：点对点协议，用于点到点链路上封装、传递网络数据包，支持多种网络层协议、验证，可同步/异步工作，易扩展。
        *   **帧中继 (Frame Relay)**：数据链路层快速分组交换技术，采用虚电路，进行统计复用、帧透明传输和错误检测。
*   **广域网连接方式**：
    *   **裸光纤方式**：用户独占永久性、点对点或点对多点光纤传输线路，不共享物理链路。传输带宽无限，速度取决于设备，常用于数据中心同城灾备。
    *   **专线方式**：多用户共享物理介质（如光纤），通过时分复用或波分复用技术，每个用户独占时隙或波长。通常由运营商提供，面向大型企业或对数据接入/互联要求高的客户。
        *   **SDH (Synchronous Digital Hierarchy)**：传统电路交换技术，通过时分复用将物理链路划分为独立时隙，提供同步、透明数字电路连接。
        *   **MSTP (Multi-Service Transport platform)**：基于 SDH 平台，实现 TDM、ATM、以太网等业务的接入、处理和传送。
        *   **OTN (Optical Transport Network)**：光传送网，基于 WDM 技术，提供超大传输容量和 SDH 的操作、维护、管理与指配 (OAM) 能力，主要用于核心层大颗粒带宽调度。
    *   **虚拟专用网络 (Virtual Private Network, VPN)**：利用共享的公共网络（如 Internet 或 ISP 骨干网）仿真构建的专用私有网络，提供安全性、可靠性和可管理性。
*   **广域网络设备角色**：
    *   **CE (Customer Edge，用户边缘设备)**：用户端连接服务提供商边缘设备的设备，实现用户接入。
    *   **PE (Provider Edge，服务提供商边缘设备)**：服务提供商连接 CE 设备的边缘设备，同时连接 P 设备，是重要的网络节点。
    *   **P (Provider，服务提供商设备)**：服务提供商内部设备，不直接连接任何 CE 设备。
*   **广域网技术应用**：
    *   **早期技术**：主要针对不同物理链路类型，在数据链路层进行不同的二层封装。常用封装协议：PPP/HDLC/FR。
        *   **ATM (Asynchronous Transfer Mode)**：异步传输模式，ISP 内部骨干网常用协议，解决骨干网高速转发问题。基于信元交换，速率高、延迟小、传输质量有保障，成本高，支持多种数据类型，可承载 IP 数据包。
    *   **现状**：
        *   **以太网广泛应用**：以太网接入成为主流，因其性价比、可扩展性、可靠性、IP 网络适应性等优势，已成为宽带接入网络和运营商城域网、骨干网的首选技术。
        *   **MPLS (Multiprotocol Label Switching)**：多协议标签交换，结合 ATM 和 IP 技术优点，通过标签封装网络层分组，实现一次查表转发，解决 IP 协议 QoS 缺陷，取代 ATM。
        *   **SR (Segment Routing)**：下一代 MPLS 技术，继承 MPLS 优势，颠覆其劣势，已广泛应用。

---
## 第28章 配置 PPP

*   **PPP 协议概述**：
    *   **基本概念**：PPP (Point-to-Point Protocol，点对点协议) 是一种数据链路层协议，用于在点到点链路上封装和传递网络层数据包。它支持同步和异步线路、验证和地址协商，易于扩展，取代了 SLIP 协议。
    *   **特点**：
        *   **工作方式**：支持同步和异步线路。
        *   **链路控制**：通过 LCP (Link Control Protocol) 有效控制数据链路的建立。
        *   **安全性**：支持 PAP (Password Authentication Protocol) 和 CHAP (Challenge-Handshake Authentication Protocol) 两种验证协议，提供更安全的网络。
        *   **多协议支持**：通过 NCP (Network Control Protocol) 支持多种网络层协议（如 IPCP 和 IPXCP）。
        *   **地址协商**：可对网络层地址进行协商，支持 IP 地址远程分配，满足拨号线路需求。
        *   **开销小**：无重传机制，网络开销小。
    *   **PPP 协议的组成**：
        *   **LCP (Link Control Protocol)**：链路控制协议，用于管理 PPP 数据链路的建立、拆除和监控。
        *   **NCP (Network Control Protocol)**：网络控制协议，用于协商所承载网络层协议的类型、属性、数据包格式和网络层地址。
        *   **PAP (Password Authentication Protocol)** 和 **CHAP (Challenge-Handshake Authentication Protocol)**：可选验证协议，用于验证对端身份，保证链路安全性。
*   **PPP 协议会话**：
    *   **PPP 会话建立的过程**：
        1.  **链路建立阶段**：运行 LCP 协议，通过发送 LCP 报文检测链路可用性。若可用，成功建立链路；否则失败。
        2.  **验证阶段 (可选)**：链路建立成功后，根据 PPP 帧中的验证选项决定是否验证。若需要，启动 PAP 或 CHAP 验证。验证成功后进入网络协商阶段。
        3.  **网络层协商阶段**：运行 NCP 协议，协商并配置双方使用的网络层协议（如 IP 或 IPX）和对应的网络层地址。协商成功则 PPP 链路建立成功。
    *   **PPP 会话流程**：
        *   **Dead 阶段**：物理层不可用。
        *   **Establish 阶段**：物理层可用，LCP 协商建立底层链路。
        *   **Authenticate 阶段**：可选，进行 PAP 或 CHAP 验证。
        *   **Network 阶段**：验证成功，NCP 协商网络层协议参数（如 IP 地址）。
        *   **Terminate 阶段**：验证失败或明确关闭链路，拆除链路。
*   **PPP 验证**：
    *   **PAP (Password Authentication Protocol)**：
        *   **特点**：两次握手验证，密码以明文方式在链路上发送，安全性较低。被验证方首先发起验证请求。
        *   **过程**：被验证方发送用户名和密码给主验证方，主验证方核实后发送 ACK 或 NAK。
    *   **CHAP (Challenge-Handshake Authentication Protocol)**：
        *   **特点**：三次握手验证，只在网络上传输用户名，不传输密码，安全性高于 PAP。主验证方首先发起验证请求。
        *   **过程**：主验证方发送随机挑战值和用户名，被验证方用密码和挑战值计算摘要并发送，主验证方核实摘要后发送 Acknowledge 或 Not Acknowledge。
    *   **PAP 与 CHAP 的对比**：
        *   **握手次数**：PAP 两次，CHAP 三次。
        *   **密码传输**：PAP 明文，CHAP 不传输密码（只传输摘要）。
        *   **安全性**：CHAP 高于 PAP。
        *   **双向验证**：PAP 和 CHAP 都支持双向身份验证。
*   **配置 PPP**：
    *   **PPP 基本配置**：
        1.  在接口视图下封装 PPP 协议：`link-protocol ppp`。
        2.  在接口视图下设置验证类型：`ppp authentication-mode { pap | chap } [ domain isp-name ]`。
        3.  在全局视图下配置本地用户、密码和服务类型：`local-user user-name class network`，`password { cipher | simple } password`，`service-type ppp`。
    *   **配置 PPP PAP 验证**：
        1.  主验证方配置本地验证对端方式为 PAP：`ppp authentication-mode pap`。
        2.  主验证方配置对端用户名和密码：`local-user user-name password { cipher | simple } password`。
        3.  被验证方配置本地用户名和密码：`ppp pap local-user username password { cipher | simple } password`。
    *   **配置 PPP CHAP 验证**：
        1.  主验证方配置本地验证对端方式为 CHAP：`ppp authentication-mode chap`。
        2.  主验证方配置本地用户名称：`ppp chap user username`。
        3.  主验证方配置对端用户名和密码：`local-user user-name password { cipher | simple } password`。
        4.  被验证方配置本地用户名称：`ppp chap user username`。
        5.  被验证方配置本地用户密码：`ppp chap password { cipher | simple } password`。
*   **PPP MP (Multilink PPP，多链路 PPP)**：
    *   **简介**：将多个 PPP 链路捆绑成一个逻辑链路 (Bundle)，实现增加带宽、负载分担、链路备份和降低报文时延。
    *   **实现方式**：
        *   **虚拟模板接口 (Virtual-Template, VT) 方式**：与验证结合，根据对端用户名找到虚拟模板接口，派生多个捆绑，每个捆绑对应一条 MP 链路。更灵活，支持点对多点拓扑。
        *   **MP-Group 接口方式**：MP-Group 是 MP 专用接口，一个 MP-Group 只能对应一个绑定。只能在物理接口下配置验证。配置简单，易于理解。
    *   **配置**：
        *   **虚模板方式**：
            1.  创建虚拟模板接口：`interface virtual-template number`。
            2.  将物理接口与虚拟模板接口关联：`ppp mp virtual-template number`。
            3.  或将用户名与虚拟模板接口关联：`ppp mp user username bind virtual-template number`。
            4.  在虚拟模板接口下配置捆绑方式：`ppp mp binding-mode authentication`。
        *   **MP-Group 方式**：
            1.  创建 MP-Group 接口：`interface Mp-group mp-number`。
            2.  将物理接口加入 MP-Group 组：`ppp mp Mp-group mp-number`。
*   **PPP 协议显示与调试**：
    *   **显示 PPP 配置和运行状态**：`display interface [ interface-name ]`。
    *   **显示 MP-Group 接口状态**：`display interface Mp-group [ mp-number ]`。
    *   **显示 MP 接口信息和统计信息**：`display ppp mp [ interface interface-type interface-number ]`。
    *   **显示 PPP 验证的本地用户**：`display users`。
    *   **调试 PPP**：`debugging ppp all [ interface interface-type interface-number ]`。

---
## 第29章 以太网接入

*   **以太网接入的典型应用**：
    *   **背景**：IP 技术发展，话音、数据、视频、移动等应用融合，以太网技术成为固网运营商改造网络、承载新型业务的主流技术。
    *   **优点**：标准化程度高、应用广泛、带宽强、扩展性好、技术成熟、性价比高、良好支持 IP。
    *   **组网角色**：
        *   **HG (Home Gateway，家庭网关)**：用户侧设备。
        *   **AN (Access Node，接入点)**：运营商接入网边缘设备。
        *   **AGG (Aggregation，汇聚设备)**：AN 和运营商城域网/骨干网之间的设备。
    *   **园区接入**：
        *   **AN 部署三层交换机**：AN 上行通过路由协议转发，下行通过 VLAN 隔离用户。广播域限制在 AN 下行业务 VLAN 内，提高了带宽利用率。一个 AGG 可接入更多用户终端。
        *   **AN 部署二层交换机**：广播域范围扩大到 AGG。一个 AGG 接入用户终端数受限于 MAC 地址表项。
*   **PPPoE 原理及配置**：
    *   **原理**：
        *   **定义**：PPPoE (Point-to-Point Protocol over Ethernet) 技术将 PPP 报文封装在以太网帧内，在以太网上提供点到点连接，并利用 PPP 协议的 PAP 和 CHAP 认证方式对用户进行认证。
        *   **工作方式**：客户端/服务器 (Client/Server) 方式。PPPoE Client 可以是 HG 或 PC，PPPoE Server 通常是 BRAS (Broadband Remote Access Server)。
        *   **阶段**：
            1.  **Discovery 阶段**：PPPoE Client 广播 PADI (PPPoE Active Discovery Initiation) 报文寻找 PPPoE Server。PPPoE Server 回复 PADO (PPPoE Active Discovery Offer) 报文。PPPoE Client 选择一个 Server 并发送 PADR (PPPoE Active Discovery Request) 报文。PPPoE Server 回复 PADS (PPPoE Active Discovery Session-Confirmation) 报文，其中包含 Session ID。
            2.  **PPP Session 阶段**：Discovery 阶段完成后，PPPoE Client 和 PPPoE Server 之间建立 PPP 连接，进行 LCP、NCP、IPCP 协商，完成 PPP 验证和 IP 地址分配。会话建立后，任意一方可发送 PADT (PPPoE Active Discovery Terminate) 报文终止会话。
    *   **PPPoE Server 的配置命令**：
        1.  **创建虚拟接口模板**：`interface virtual-template number`。
        2.  **配置虚拟模板参数**：在虚拟接口模板视图下配置验证方式 (`ppp authentication-mode { pap | chap } [ domain isp-name ]`) 和 IP 地址获取方式（如 DHCP）。
        3.  **在以太网接口上启用 PPPoE 协议并绑定虚拟模板**：`pppoe-server bind virtual-template number`。
        4.  **配置本地用户、密码和服务类型**（用于验证）：`local-user user-name class network`，`password { cipher | simple } password`，`service-type ppp`。
        5.  **配置 DHCP 地址池**（用于分配 IP 地址）：`dhcp enable`，`dhcp server ip-pool pool-name`，`network network-address [ mask-length | mask mask ]`，`gateway-list ip-address &<1-8>`，`dns-list ip-address &<1-8>`。
    *   **PPPoE Client 的配置命令**：
        1.  **配置拨号访问组规则**：`dialer-rule group-number rule { protocol-name { deny | permit } | acl { acl-number | name acl-name } }`。
        2.  **创建 Dialer 接口**：`interface dialer number`。
        3.  **配置 Dialer 接口 IP 地址**：`ip address { address mask | ppp-negotiate }`。
        4.  **使能共享 DDR**：`dialer bundle enable`。
        5.  **配置 Dialer Group**：`dialer-group group-number`。
        6.  **在以太网接口建立 PPPoE 会话并绑定 Dialer Bundle**：`pppoe-client dial-bundle-number number [ no-hostuniq ]`。
        7.  **配置 Dialer 接口空闲时间**：`dialer timer idle idle` (0 表示永久在线)。
*   **PPPoE 典型配置实例**：涵盖 Server 端和 Client 端的完整配置流程。

---
## 第30章 SR 技术基础

*   **SR 技术产生的背景**：
    *   **IP 转发的问题**：
        *   **性能较低**：传统路由器采用最长匹配算法，需要多次查表，效率不高。早期路由器多采用 CPU 转发，性能有限。
        *   **面向无连接**：无法提供较好的端到端 QoS 保障。
    *   **MPLS 转发的特点和劣势**：
        *   **优点**：
            *   通过标签封装网络层分组，一次查表，提高数据传输效率。
            *   隧道技术，支持 VPN 和流量工程 (TE)。
            *   面向连接的转发，有利于 QoS。
        *   **劣势**：
            *   **控制协议复杂**：需要部署额外的标签分发控制协议（如 LDP），增加了配置复杂性。
            *   **网络扩展性差**：每个节点都需要计算路径和维护链接状态，节点间需要发送大量消息，浪费带宽和设备资源。
*   **SR 基本概念及工作原理**：
    *   **定义**：SR (Segment Routing，分段路由) 是一种基于源路由理念的协议，将网络路径分成一个个段 (Segment)，并为段和网络节点分配 **Segment ID (SID)**。
    *   **SID (Segment ID)**：段标识，用于标识 SR 域内唯一的段，在 MPLS SR 中为 MPLS 标签，在 SRv6 中为 IPv6 报文头。
    *   **Segment**：段，表示网络指令，指明节点对入报文执行的操作。
    *   **转发方式**：
        1.  源节点 R1 根据栈顶标签 102 查找标签转发表，判断下一跳为 R2。
        2.  R2 接收报文后，根据入标签 203 查找标签转发表，判断下一跳为 R3，并删除最外层标签 203。
        3.  R3 接收报文后，根据入标签 306 查找标签转发表，判断下一跳为 R6，并删除最外层标签 306。
        4.  R6 接收报文后，根据入标签 607 查找标签转发表，判断下一跳为 R7，并删除最外层标签 607。
        5.  R7 收到 IP 报文，按 IP 转发。
*   **SR 技术的优势**：
    *   **更简单的控制平面**：在 MPLS 网络中，SR 扩展了 IGP/BGP 的标签分发能力，无需其他标签分发协议，或由控制器统一分配 SR 标签。
    *   **易扩展的数据平面**：复用 MPLS 和 IPv6 转发平面，设备无需改动或少量修改即可支持 SR 转发。
    *   **更快捷的路径选择**：采用源路由方式转发，中间节点无需维护路径信息，简化了控制平面，符合 SDN 转控分离理念。
*   **SR 应用场景**：
    *   **与 SDN 控制器结合**：SR 与 SDN 架构结合，利用设备自主转发和集中编程控制的优势。
    *   **BGP-LS (BGP Link-state)**：设备通过 BGP-LS 将网络拓扑信息同步到 SDN 控制器，控制器根据业务需求选择路径，并通过 NETCONF 协议下发配置。
    *   **优点**：降低上层控制器计算能力要求，汇总 IGP 拓扑信息，有利于路径选择和计算。

---
## 第31章 配置 4G/5G

*   **4G/5G 技术概述**：
    *   **基本概念**：
        *   **LTE (Long Term Evolution)**：通常指 4G，由 ITU 3GPP 于 2004 年底提出，2009 年正式标准化并部分商用。
        *   **NR (New Radio)**：5G，基于 OFDM 的全新空口设计，全球性 5G 标准，实现超低时延、高可靠性。
    *   **技术特点**：
        *   **全球统一频段**：与 2G/3G 相比，频段统一性更高。
        *   **全球统一制式**：4G/5G 技术标准趋于统一，包括 TDD-LTE 和 FDD-LTE。5G NR 统一为 5G 标准。
        *   **全球无缝漫游能力**：技术标准趋同促进了漫游能力发展。
        *   **高频谱效率**：比 2G/3G 提升数十倍。
        *   **支持高速移动多媒体业务**：数据速率大幅提升，报文时延降低。
    *   **技术标准**：
        *   **FDD-LTE (Frequency Division Duplexing-LTE)**：频分双工，由 3GPP 制定，中国联通、电信主要采用。
        *   **TDD-LTE (Time Division Duplexing-LTE)**：时分双工，由 3GPP 制定，中国移动主要采用。
        *   **5G NR**：由 3GPP 制定，采用新空口，中国联通、电信、移动、广电均有部署。
    *   **频段划分**：中国移动、联通、电信、广电在 4G 和 5G 上分配了不同的频段。
*   **4G/5G 接入方式**：
    *   **MSR 路由器支持的接入方式**：
        *   **SIM 卡接入**：MSR 路由器内置 4G/5G 接口，通过插入 SIM 卡进行拨号。MSR8XX-LM 支持 4G LTE，MSR10XX-5G 支持 5G NR，均支持全网通。
        *   **USB Modem 接入**：MSR 路由器 USB 接口插入 USB 4G Modem 实现拨号。标准不统一，支持 Modem 较少，不推荐。
        *   **SIC-4G/5G 模块接入**：MSR 路由器插入 SIC-4G/5G 单板模块。根据运营商区分选配模块。
    *   **无线通信方案特点**：
        *   **高带宽、高可用性**：带宽大幅提升，可用性增强。
        *   **满足移动通信需求**：适用于不便获取有线链路或需移动通信的场景。
        *   **网络安全**：公网环境，路由器提供网络和数据加密功能，解除安全隐患。
        *   **功能完善**：封装为标准 IP 接口，与有线接口无功能和业务差异。
*   **配置 4G/5G**：
    *   **4G/5G 基本配置**：
        1.  **配置拨号访问组和控制条件**：`dialer-rule group-number rule { protocol-name { deny | permit } | acl { acl-number | name acl-name } }`。
        2.  **配置 4G/5G Modem 参数模板**：`apn-profile profile-name`，`apn { dynamic | static apn }`。
        3.  **将 Cellular 接口通道化出以太网通道接口**：`controller cellular x/x`，`eth-channel 0`。
        4.  **在 Eth-channelx/x:0 接口获取运营商自动分配的 IP 地址**：`ip address cellular-alloc`。
        5.  **在 Eth-channelx/x:0 接口开启 DDR 并关联拨号访问组**：`dialer circular enable`，`dialer-group 1`。
        6.  **配置拨号参数**：`dialer timer idle idle`，`dialer timer wait-carrier wait-carrier`，`dialer timer autodial autodial-interval`。
        7.  **配置拨号串**：`dialer number *99# autodial` （移动/联通）或 `dialer number #777 autodial` （电信）。
        8.  **配置 NAT**：`nat outbound` (允许内部报文地址转换)。
        9.  **配置静态路由**：`ip route-static 0.0.0.0 0.0.0.0 eth-channel x/x:0`。
*   **4G/5G 的显示与调试**：
    *   **显示 4G/5G Modem 呼叫连接信息**：`display cellular interface-number`。
    *   **清除指定接口的统计信息**：`reset counters interface [ cellular [ interface-number ] ]`。
    *   **查看 4G/5G 拨号过程的调试信息**：`terminal debugging`，`terminal monitor`，`debugging cellular error`，`debugging cellular event`，`debugging cellular plugin all`，`debugging physical all controller Cellular x/0`。
    *   **4G/5G 状态信息**：
        *   **Modem State**：`Online` 表示正常工作，`Offline` 表示下电或省电状态。
        *   **SIM Status**：`OK` 表示正常使用，`Network Reject` 表示被拒绝，`Not Insert` 表示未插入 SIM 卡。
        *   **信号强度 (RSRP)**：描述接入网络信号状态，通常要求在 -110dBm 以内，大于 -89dBm 用户体验较好。
        *   **拨号失败信息**：`IPv4/IPv6 dialing failed` 字段显示拨号异常原因。